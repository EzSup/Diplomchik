@using Restaurant.Client.Pages.Tables
@using Restaurant.Client.Contracts.Tables
@using Restaurant.Client.Contracts.Enums
@inject ITablesService tablesService
@inject IBillsService billsService
@page "/selectTable"
<Title>Choose the table</Title>
<div class="Container">
    <div style="display: flex;">
        <InputDate @oninput="DatePicked" @bind-Value="date"
            min="@DateTime.Today.ToString("yyyy-MM-dd")"
            max="@DateTime.Today.AddMonths(3).ToString("yyyy-MM-dd")"></InputDate>
        <select @onchange="TimePicked">
            @for (int i = 8; i <= 20; i++)
            {
                TimeOnly time = new TimeOnly(i, 0, 0);
                <option value="@time" disabled="@(date.Date == DateTime.Today.Date && time.Hour <= DateTime.Now.Hour )" selected="@(time.Hour == DateTime.Now.Hour+1)">@*  *@
                    @time.Hour:00
                </option>
            }
        </select>
    </div>
    <div class="Content-wrap">
        @if (tables != null && tables.Length >= 8)
        {
            <InputRadioGroup @bind-Value="table">
                <div class="wrap-col" style="width: 40%">
                    <div class="wrap-col-content content-flex-start">
                        <TwoSeatsTable Value="@tables[0].Id" Disabled="@(!tables[0].Free)" />
                    </div>
                    <div class="wrap-col-content flex-row mid">
                        <SixSeatsTable Value="@tables[4].Id" Disabled="@(!tables[4].Free)" />
                        <SixSeatsTable Value="@tables[5].Id" Disabled="@(!tables[5].Free)" />
                    </div>
                </div>
                <div class="wrap-col" style="width: 60%">
                    <div class="wrap-col-content flex-row justify-center">
                        <EightSeatsTable Value="@tables[6].Id" Disabled="@(!tables[6].Free)" />
                        <EightSeatsTable Value="@tables[7].Id" Disabled="@(!tables[7].Free)" />
                    </div>
                    <div class="wrap-col-content flex-row mid">
                        <FourSeatsTable Value="@tables[2].Id" Disabled="@(!tables[2].Free)" />
                        <FourSeatsTable Value="@tables[3].Id" Disabled="@(!tables[3].Free)" />
                    </div>
                    <div class="wrap-col-content flex-row justify-end content-flex-end">
                        <TwoSeatsTableHorizontal Value="@tables[1].Id" />
                    </div>
                </div>
            </InputRadioGroup>
        }
    </div>
    <AuthorizeView Roles="User">
        <Authorized>
            @if (table != Guid.Empty)
            {
                <button style="color: black;" @onclick="ReserveTable">Reserve</button>
            }
        </Authorized>
    </AuthorizeView>
</div>
@code {
    DateTime date;
    TimeOnly time;
    Guid table = Guid.Empty;
    TableResponse[] tables;

    protected override async Task OnInitializedAsync()
    {
        //await localStorage.AddItem("orderType", ((int)OrderType.InRestaurant).ToString());
        DateTime dateNow = DateTime.Now;
        date = new DateTime(dateNow.Year, dateNow.Month, dateNow.Day, dateNow.Hour + 1, 0, 0);
        tables = (await tablesService.GetTablesOfTime(date)).ToArray();
    }

    private async Task TimePicked(ChangeEventArgs e)
    {
        string selectedTime = e.Value.ToString();
        time = TimeOnly.Parse(selectedTime);
        date = new DateTime(date.Year, date.Month, date.Day,
            time.Hour, time.Minute, time.Second);
        tables = (await tablesService.GetTablesOfTime(date)).ToArray();
    }

    private async Task DatePicked(ChangeEventArgs e)
    {
        var enteredDate = DateTime.Parse(e.Value.ToString());
        date = new DateTime(enteredDate.Year, enteredDate.Month, enteredDate.Day,
            time.Hour, time.Minute, time.Second);
        tables = (await tablesService.GetTablesOfTime(date)).ToArray();
    }

    private async Task ReserveTable()
    {
        var request = new ReserveRequest()
            {
                tableId = table,
                start = date
            };
        var result = await tablesService.Reserve(request);
        if (result != Guid.Empty)
        {
            var billId = await billsService.AddBill(result, OrderType.InRestaurant);
            NavManager.NavigateTo($"/billData/{billId}");
        }
    }

    private async Task TableClicked()
    {

    }
}
